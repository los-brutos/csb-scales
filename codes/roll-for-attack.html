<!-- Roll for attack -->
${#concat(
  ?{diff:"Difficulté"|"2","Normal"|"0","Facile"|"4","Difficile"},
  ?{modificateur:"Modificateur"[number]|0}
)}$

<!-- vérification qu'une cible a bien été sélectionnée -->
${#nameTarget:= fetchFromActor("target", "name", "")}$
${#(nameTarget?"":notify("error", "Vous devez sélectionner une cible !"))}$

<!-- récupération des données -->
${#sante:=       healthMalus}$
${#combativite:= fightness}$
${#type:=        item.combatType}$
${#bonusArme:=   item.attackBonus ? item.attackBonus : 0}$

<!-- définition des valeurs par défaut -->
${#ccCombatCarrier:=       ccCombatCarrier       ? ccCombatCarrier       : ""}$
${#ccCombatHobby:=         ccCombatHobby         ? ccCombatHobby         : ""}$
${#contactCombatCarrier:=  contactCombatCarrier  ? contactCombatCarrier  : ""}$
${#contactCombatHobby:=    contactCombatHobby    ? contactCombatHobby    : ""}$
${#distanceCombatCarrier:= distanceCombatCarrier ? distanceCombatCarrier : ""}$
${#distanceCombatHobby:=   distanceCombatHobby   ? distanceCombatHobby   : ""}$

${#default:= 6}$
${#ccCombatCarrierLevel:=       first(fetchFromDynamicTable('carriers', 'level', 'name', ccCombatCarrier),       default)}$
${#ccCombatHobbyLevel:=         first(fetchFromDynamicTable('hobbies',  'level', 'name', ccCombatHobby),         default)}$
${#contactCombatCarrierLevel:=  first(fetchFromDynamicTable('carriers', 'level', 'name', contactCombatCarrier),  default)}$
${#contactCombatHobbyLevel:=    first(fetchFromDynamicTable('hobbies',  'level', 'name', contactCombatHobby),    default)}$
${#distanceCombatCarrierLevel:= first(fetchFromDynamicTable('carriers', 'level', 'name', distanceCombatCarrier), default)}$
${#distanceCombatHobbyLevel:=   first(fetchFromDynamicTable('hobbies',  'level', 'name', distanceCombatHobby),   default)}$

<!-- définition du nom du métier ou du hobby de référence -->
${#ccName:=       ccCombatCarrierLevel       >= ccCombatHobbyLevel       ? ccCombatHobby       : ccCombatCarrier}$
${#contactName:=  contactCombatCarrierLevel  >= contactCombatHobbyLevel  ? contactCombatHobby  : contactCombatCarrier}$
${#distanceName:= distanceCombatCarrierLevel >= distanceCombatHobbyLevel ? distanceCombatHobby : distanceCombatCarrier}$
${#carrierHobby:= switchCase(type, "1", ccName, "2", contactName, "3", distanceName, "")}$
${#carrierHobby:= equalText("", carrierHobby) ? "Non qualifié" : carrierHobby}$

<!-- définition du niveau du métier ou du hobby de référence -->
${#ccLevel:=       ccCombatCarrierLevel       >= ccCombatHobbyLevel       ? ccCombatHobbyLevel       : ccCombatCarrierLevel}$
${#contactLevel:=  contactCombatCarrierLevel  >= contactCombatHobbyLevel  ? contactCombatHobbyLevel  : contactCombatCarrierLevel}$
${#distanceLevel:= distanceCombatCarrierLevel >= distanceCombatHobbyLevel ? distanceCombatHobbyLevel : distanceCombatCarrierLevel}$
${#level:=switchCase(type, "1", ccLevel, "2", contactLevel, "3", distanceLevel, default)}$

<!-- définition de la caractéristique de référence -->
${#caracteristiqueName:= (1 == type ? ccCombatCharacteristic : 2 == type ? contactCombatCharacteristic : 3 == type ? distanceCombatCharacteristic : "")}$
${#caracteristique:= first(fetchFromDynamicTable('characteristics', 'value', 'name', caracteristiqueName), 0)}$

<!-- combativité de la cible -->
${#combativiteAdverse:=(3 == type ? fetchFromActor('target', 'fightness') : 0)}$

<!-- calcul du seuil de réussite -->
${#seuil:= 10 - level - diff}$

<!-- calcul du bonus si le seuil est supérieur à 10 -->
${#seuilTemp:= seuil + caracteristique + combativite + combativiteAdverse + bonusArme + modificateur + sante}$
${#bonus:=(seuilTemp > 10 ? seuilTemp - 10 : 0)}$

<h3><strong>${!item.name}$</strong> : attaque ${!(0 == diff ? "facile" : (2 == diff ? "normale":"difficile"))}$ ${!and(not(equalText(carrierHobby, "")), 0 != caracteristique) ? "avec" : ""}$ ${! carrierHobby}$ ${! 0 != caracteristique ? concat("et ", caracteristiqueName) : ""}$</h3>
<table>
  <tbody>
    <tr>
      <td><h4>Jet du dé</h4></td>
      <td>
        <strong>${roll:= [1d10] + bonus}$</strong> / ${seuil:=seuil + caracteristique + combativite + combativiteAdverse + bonusArme + modificateur + sante}$
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <p style="padding: 2px; text-align: center; font-weight: bold; ${!roll<=seuil ? "color: var(--color-level-success); border: solid 1px var(--color-level-success)\">Réussite" : "color: var(--color-level-error); border: solid 1px var(--color-level-error)\">Echec"}$</p>
      </td>
    </tr>
  </tbody>
</table>