<!-- Jet pour calculer les dégâts des armes aux corps-à-corps, contact et distance -->
${#concat(
  ?{powerfull:"Puissance"|1,concat("Faible",(1==item.powerfullMax?" (max)":""))|2,concat("Moyenne",(2==item.powerfullMax?" (max)":""))|3,concat("Forte",(3==item.powerfullMax?" (max)":""))},
  ?{modificateur:"Modificateur"[number]|0}
)}$

<!-- vérification qu'une cible a bien été sélectionnée -->
${#nameTarget:= fetchFromActor("target", "name", "")}$
${#(nameTarget?"":notify("error", "Vous devez sélectionner une cible !"))}$

<!-- récupération des données -->
${#combativite:=fightness}$
${#type:=item.combatType}$
${#bonusArme:= item.damageBonus ? item.damageBonus : 0}$
${#protectionAdverse:= -1*(3 == type ? fetchFromActor("target", "distanceArmorEquiped", 0) : fetchFromActor("target", "ccArmorEquiped", 0))}$

<!-- bonus de la caracteristique si combat corps-à-corps ou contact -->
${#bonusForce:=(3 == type ? 0 : powerfullCharacteristic)}$

<!-- malus de la résistance de la cible -->
${#resistanceAdverse:=(-1 * fetchFromActor("target", "resistanceCharacteristic", 0))}$

<h3>Dégats de puissance ${!switchCase(powerfull, "1", "Faible","2", "Moyenne","3", "Forte", "<i>non définie</i>")}$ sur <strong>${#nameTarget}$</strong> par @{selected|name}</h3>

<!-- vérification de la puissance utilisée -->
${!(powerfull > item.powerfullMax
  ? "<div style=\"padding: 2px; text-align: center; color: var(--color-level-warning); border: solid 1px var(--color-level-warning)\">La <strong>puissance choisie</strong> doit être <strong>inférieure ou</strong> égale à la <strong>puissance maximale</strong> de l'attaque</div>"
  :""
)}$

<!--
code blessures :
*  0 = Rien
* 10 = Légèrement sonné
* 20 = Sonné
* 30 = Assommé
* 40 = Dommage critique
* 50 = Egratignure
* 60 = Blessure légère
* 70 = Blessure grave
* 80 = Coma
* 90 = Mort
-->

<table>
  <tbody>
    <tr>
      <td><h4>Jet du dé</h4></td>
      <td>
        <i class="fas fa-dice-d10"></i>
        <span>${!roll:= [1d10]}$</span>
      </td>
    </tr>
    <tr>
      <td><h4>Dégâts</h4></td>
      <td>
        <strong>${roll:= roll + combativite + bonusForce + resistanceAdverse + protectionAdverse + bonusArme + modificateur}$</strong>
      </td>
    </tr>
${#damage:=switchCase(type, "1", switchCase(powerfull, "1", (3 >= roll ? 0:(7 >= roll ? 10 : 20)), "2", (3 >= roll ? 10 : (7 >= roll ? 20 : 30)), "3", (3 >= roll ? 20 : (7 >= roll ? 30 : 40))), "2", switchCase(powerfull, "1", (3 >= roll ? 0:(7 >= roll ? 50 : 60)), "2", (3 >= roll ? 50 : (7 >= roll ? 60 : 70)), "3", (3 >= roll ? 60 : (7 >= roll ? 70 : 80))), "3", switchCase(powerfull, "1", (3 >= roll ? 0:(7 >= roll ? 60 : 70)), "2", (3 >= roll ? 60 : (7 >= roll ? 70 : 80)), "3", (3 >= roll ? 70 : (7 >= roll ? 80 : 90))))}$

${#damageName:=switchCase(damage, 0, "Rien", 10, "Légèrement sonné", 20, "Sonné", 30, "Assommé", 40, "Dommage critique", 50, "Egratignure", 60, "Blessure légère", 70, "Blessure grave", 80, "Coma", 90, "Mort")}$

${#damageDetail:=switchCase(damage, 0, "Loupé !", 10, "Le personnage subit un <strong>malus de 2 points</strong> à toutes ses chances de réussite <strong>au cours du tour suivant</strong> et uniquement celui-ci.", 20, "Le personnage subit <strong>un malus de 2 points</strong> à toutes ses chances de réussite jusqu'à ce qu'il puisse récupérer en se reposant environ cinq minutes. <br/>S'il est sonné une seconde fois avant de s'être reposé, il est considéré comme Assommé.", 30, "Le personnage s'évanouit <strong>pour ${[1d10]}$ minutes</strong> s'il est convenablement soigné.</strong> <br/>Sans aucune aide extérieure l'évanouissement sera <strong>cinq fois plus long</strong>.", 40, "Le personnage est <strong>Assommé</strong>  pour <strong>${[1d10]}$ minutes</strong> et subit une <strong>Blessure Légère</strong>.", 50, "L'attaque n'a qu'un effet sanguinolent sans aucune conséquence grave. Le sang coule, mais un bon pansement devrait pouvoir l'arrêter et éviter que la cicatrice ne soit trop visible.", 60, "Le personnage est meurtri dans sa chair mais sans que cela ait des conséquences vraiment fâcheuses. La douleur cause un <strong>malus de 1 point</strong> à toutes ses chances de réussite tant que la blessure n'est pas soignée (ce qui prend généralement quelques jours). <br/>Une seconde blessure légère reçue moins d'une heure après la première cause une blessure grave (après une heure, la blessure reste légère).", 70, "Le personnage est blessé à un endroit grave. La douleur et la gêne causées par la blessure donnent un <strong>malus de 2 points</strong> à toutes ses chances de réussite tant que la blessure n'est pas soignée (ce qui prend généralement plusieurs semaines d'hôpital).<br/>Une seconde blessure grave reçue moins d'une heure après la première cause un coma immédiat (après une heure, la blessure reste grave).", 80, "Le personnage est aux portes de la mort. Il lutte de toutes ses forces pour rester en vie mais sombre néanmoins dans un profond coma. Il ne pourra être réanimé qu'avec des moyens médicaux importants. <strong>S'il n'est pas secouru avant une heure, il meurt sans jamais reprendre conscience</strong>.<br/>Un second coma moins d'une heure après le premier cause la mort immédiate de la victime (après un heure, la blessure reste un coma).", 90, "Le personnage est mortellement touché. Il peut à la rigueur s'en sortir avec des séquelles s'il est soigné rapidement (dans les 5 minutes) et s'il est ensuite suivi médicalement avec des appareils médicaux de haute technologie.")}$
    <tr>
      <td colspan="2">
        <p style="padding: 2px; text-align: center; border: solid 1px var(--color-border-dark)">
          <strong>${!damageName}$</strong>
        </p>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <p style="padding: 2px; text-align: justify; border: solid 1px var(--color-border-dark)">
          ${!damageDetail}$
        </p>
      </td>
    </tr>
  </tbody>
</table>

<!-- application des dégâts à la cible 
IF (dommage >= 50 AND dommage >= target.health) THEN
  AppliquerDommageHealth()
ELSE
  IF (dommage == 40 AND 60 > target.health) THEN
    AppliquerDommageCritique()
  ELSE
    IF (30 >= dommage AND dommage >= target.stun) THEN
      AppliquerDommageStun()
    ELSE
      // ne rien faire
    FI
  FI
FI
-->


${stunTarget:= fetchFromActor('target', 'stun')}$
<br/>
${healthTarget:= fetchFromActor('target', 'health')}$
<br/>
${#assomme:=30}$
${#blessureLegere:=60}$
${setPropertyInEntity('target', 'stun', ref("assomme"))}$



${$changement:=and(damage >= 50, damage > healthTarget)
  ? ${setPropertyInEntity('target', 'health', "damage")}$
  : and(40 == damage, 60 > healthTarget)
    ? ${concat(
      string(setPropertyInEntity('target', 'stun', "assomme")), 
      string(setPropertyInEntity('target', 'health', "blessureLegere")))}$
    : and(30 >= damage, damage > stunTarget)
      ? ${setPropertyInEntity('target', 'stun', "damage")}$
      : "pas de changement"
)}$
